{% if site.leancloud.enable %}
  <h3>Access Statistics</h3>
  <p id="access_statistics" style="font-size: 0.8rem;color: #9b9b9b;margin-left: 1rem;font-family: 'Lucida Console';text-align: center;">
    <span id='page_statistics'></span><span id='site_statistics'></span>
  </p>

  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

  <script>
    // leancloud 配置
    AV.initialize("{{site.leancloud.app_id}}", "{{site.leancloud.app_key}}");
    var dbClassName = 'visited_times'; // 数据库名称

    // 更新访问次数
    function updateCount(Counter) {
      var title = '{{ page.title }}';
      var url = window.location.href;
      var query = new AV.Query(Counter);            // 新建查询
      query.equalTo("post_title", title);           // 根据 title 查询记录
      query.find({
        success: function(results) {
          if (results.length > 0) {                 // 存在该记录
            var counter = results[0];               // 获取该记录
            counter.fetchWhenSave(true);
            counter.increment("visited_times");     // 将点击次数加1
            counter.save(null, {
              success: function(counter) {
                console.log('更新记录成功：' + counter.get('visited_times'));
                $('#access_statistics').find('#page_statistics').text('page: ' + counter.get('visited_times'));
              },
              error: function(counter, error) {
                console.error('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {                                  // 无此记录
            var newRecord = new Counter();
            newRecord.set("post_title", title);
            newRecord.set("post_url", url);
            newRecord.set("visited_times", 1);
            newRecord.save(null, null);
            // 若持续都是 1 则表示无法创建该记录
            $('#access_statistics').find('#page_statistics').text('page: 1');
          }
        },
        error: function(error) {
          console.log('更新页统计数失败:' + error.code + " " + error.message);
        }
      });
      query.equalTo("post_title", "{{ site.title }}"); // 获取站点总记录
      query.find({
        success: function(results) {
            var counter = results[0];                  // 获取总记录
            counter.fetchWhenSave(true);
            counter.increment("visited_times");        // 将点击次数加1
            counter.save(null, {
              success: function(counter) {
                console.log('更新站点总记录成功：' + counter.get('visited_times'));
                $('#access_statistics').find('#site_statistics').text(' - site: ' + counter.get('visited_times'));
              },
              error: function(counter, error) {
                console.error('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
        },
        error: function(error) {
          console.log('更新站点总统计数失败:' + error.code + " " + error.message);
        }
      });
    }

    // 加载函数
    $(function() {
      var Counter = AV.Object.extend(dbClassName);
      updateCount(Counter);
    });
  </script>
{% endif %}