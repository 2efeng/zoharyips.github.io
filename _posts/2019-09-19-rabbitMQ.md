---
layout: post
title: RabbitMQ 工作模式
categories: MQ
keywords: MQ
---

本文记录了 RabbitMQ 的几种工作模式

* TOC
{:toc}

## AMQP

AMQP(Advanced Message Queuing Protocol)，高级消息队列协议

### 是什么

是一个提供统一消息服务的应用层标准高级消息队列协议，是为消息中间件而设计的应用层协议的开放标准；遵循此应用协议的客户端与消息中间件之间能正常工作。

### 为什么

在 AMQP 诞生之前，对于异步消息处理技术，不同厂商的解决方案都是闭源的，各大厂商产品不相兼容且价格高昂。

2006 年，AMQP 规范发布，大部分公司开始遵循此标准进行开发，成为全行业广泛使用的消息中间件技术标准；

而消息中间件的目标，是让消息中间件的能力最终被网络本身所具有，使得 AMQP 仿佛 TCP 一般的存在；

#### AMQP 解决的问题

1. 信息的发送者和接收者如何维持连接，如果连接中断数据丢失怎么办；

2. 如何降低发送者和接受者的耦合度？

3. 如何让优先级接收者最先接收到消息？

4. 如何均衡接收者的负载？

5. 如何过滤接收者不需要的消息？

6. 如何保证接收者接收到完整正确的消息？

### 怎么做

AMQP 协议划分为两个部分：

1. **Functional Layer**：  
    提供了一套确定的消息交换模型，即“高级消息交换协议”，模型定义了路由和存储消息等功能模块，以及定义了这些模块间交换消息的规则；

2. **Transport Layer**:  
    定义了网络数据传输协议，不同的客户端通过此协议和消息代理可以实现和模型的通信；基于二进制数据流传输，不同的客户端通过此协议和消息代理可以实现和模型的通信；

### AMQP 模型

![AMQP模型](/images/posts/AMQPmodel.png "AMQP模型")

* **Blocker**：  
    消息队列服务器实体，即 MQ Server Application。  
    为 Message 提供一条从 Producer 到确定的 Consumer 之间的路线，保证消息按照指定的方式准确传输

* **Virtual Host**：  
    虚拟主机，缩写为 VHost，可视为一台概念上的 MQ 服务器。  
    一台 Blocker 中有多个 VHost，即现实中的 MQ 服务器用作多个虚拟消息队列服务器，以供 Blocker 中的不同用户作权限分离

* **Client - Publisher**：  
    提供者客户端，也称 Produce ，创建并将消息发送至 Blocker。  
    Publisher 发送的消息中携带一个叫 routingKey 的信息，指示 Blocker 根据该 routingKey 将消息放入指定的消息队列；

* **Client - Consumer**：  
    消费者客户端，消息的处理者，订阅 Blocker 中的消息队列，接收并处理消息。

* **Connection**：  
    连接，Client 与 Server 之间建立的 TCP 连接。  
    断开连接的操作只会在client端进行，Broker不会断开连接，除非出现网络故障或 broker 服务出现问题。

* **Channel**：  
    通道，建立在 Connection 中的虚拟连接。  
    通常是每个 Thread 创建单独的 Channel 进行通讯，以减轻服务器创建连接的开销；AMQP 提供了 Channel id 帮助客户端和服务器识别 Channels，所以 Channel 之间是相互隔离的。

* **Exchange**：  
    消息交换机，消息中携带的分发规则（routingKey），将消息分发到不同的消息队列。

* **Queue**：  
    消息队列，存储消息并推送消息。  
    使消息根据指定的规则进行排序或过滤，再不断地将整理后的消息发送给订阅者

* **Binding**：  
    绑定规则，每一个消息队列与消息交换机相绑定，每一条绑定规则对应一个 bindingKey。  
    bindingKey 等绑定信息存储于消息队列中的查询表中，交换机根据该表选择分发消息到目标队列。

### 工作方式

1. 二客户端与服务器建立连接 Connection

2. 根据不同业务建立不同通道 Channel

3. 提供者客户端通过 Channel 将消息发送给 Blocker 中的 Exchange

4. Exchange 根据消息中的标识将消息路由至相应的队列

5. 队列根据订阅它的客户端状态，选择将消息分发给消费者客户端

## Rabbit MQ

RabbitMQ 是根据 AMQP 协议开发的，其工作原理与 AMQP 工作原理相同

### Exchange 工作模式

Exchange 工作模式负责处理的是：Queue 与 Exchange 之间的关系

#### fanout

广播模式，直译为“扇展”，将消息发送至所有与该交换机**相绑定**的队列。

#### direct

直接模式，将消息发送至 bindingKey 与消息标识的 routingKey 相同的队列，比广播模式更具筛选效果，要求全字匹配。

#### topic

主题模式，比直接模式更为灵活，提供模糊匹配功能，规则提供了两个通配符：`#` 和 `*`

* `#`：匹配 0 至 n 个单词

* `*`：必须匹配 1 个单词

规则是关键字与通配符中加上一个 “.” 进行连接，如：`#.payment.*`、`payment.#`、`*.payment.#`。可前置可后置，可同时使用。

如：携带 “payment.jojo” routingKey 信息的消息将路由至由 `#.payment.*` 和 `payment.#` 所绑定的队列，“refound.payment.jojo” 将路由至 `#.payment.*` 和 `*.payment.#` 队列，而 “refound.payment” 将只路由至 `*.payment.#` 队列

#### headers

### Consumer 订阅模式

Consumer 订阅模式负责处理的是：Queue 与 Consumer 之间的关系

### RPC 实现

RPC 即 Remote Procedure Call，远程过程调用，其目的在于，提供者可以获取消费者消息的处理结果。
